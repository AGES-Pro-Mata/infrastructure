# üèóÔ∏è Pro-Mata Infrastructure

Infraestrutura automatizada do Pro-Mata AGES com Docker Swarm, CI/CD integrado e gest√£o de segredos. Sistema preparado para desenvolvimento (Azure) e produ√ß√£o (AWS) com alta disponibilidade.

## üìã Vis√£o Geral

Este reposit√≥rio gerencia toda a infraestrutura do Pro-Mata atrav√©s de:

- **Infrastructure as Code** (Terraform)
- **Configuration Management** (Ansible)
- **Container Orchestration** (Docker Swarm)
- **CI/CD Automatizado** (GitHub Actions)
- **Gest√£o de Segredos** (Azure Key Vault / AWS Secrets Manager)

## üóÇÔ∏è Estrutura do Projeto

```plain
infrastructure/
‚îú‚îÄ‚îÄ envs/                           # Configura√ß√µes por ambiente
‚îÇ   ‚îú‚îÄ‚îÄ dev/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ansible-vars.yml        # Vari√°veis Ansible
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars        # Vari√°veis Terraform
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ secrets/                # Segredos (encrypted)
‚îÇ   ‚îú‚îÄ‚îÄ staging/
‚îÇ   ‚îî‚îÄ‚îÄ prod/
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ deployments/                # Deployments por ambiente
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dev/                    # Azure (Docker Swarm)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ staging/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prod/                   # AWS (ECS + RDS)
‚îÇ   ‚îú‚îÄ‚îÄ backends/                   # Configura√ß√µes de backend
‚îÇ   ‚îî‚îÄ‚îÄ modules/                    # M√≥dulos reutiliz√°veis
‚îÇ       ‚îú‚îÄ‚îÄ aws/                    # M√≥dulos AWS
‚îÇ       ‚îú‚îÄ‚îÄ azure/                  # M√≥dulos Azure
‚îÇ       ‚îú‚îÄ‚îÄ dns/                    # Configura√ß√£o DNS
‚îÇ       ‚îî‚îÄ‚îÄ shared/                 # Componentes compartilhados
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ inventory/                  # Invent√°rios por ambiente
‚îÇ   ‚îú‚îÄ‚îÄ playbooks/                 # Playbooks principais
‚îÇ   ‚îî‚îÄ‚îÄ roles/                     # Roles reutiliz√°veis
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ database/                  # Custom PostgreSQL image
‚îÇ   ‚îî‚îÄ‚îÄ stacks/                    # Docker Compose stacks
‚îú‚îÄ‚îÄ scripts/                       # Scripts de automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ setup/                     # Scripts de configura√ß√£o inicial
‚îÇ   ‚îú‚îÄ‚îÄ deploy/                    # Scripts de deploy
‚îÇ   ‚îú‚îÄ‚îÄ backup/                    # Scripts de backup
‚îÇ   ‚îú‚îÄ‚îÄ security/                  # Scripts de seguran√ßa
‚îÇ   ‚îî‚îÄ‚îÄ utils/                     # Utilit√°rios diversos
‚îî‚îÄ‚îÄ .github/workflows/             # CI/CD pipelines
```

## üöÄ Como Usar

### 1. Configura√ß√£o Inicial

```bash
# Clone o reposit√≥rio
git clone https://github.com/AGES-Pro-Mata/infrastructure.git
cd infrastructure

# Configurar ambiente de desenvolvimento
cp envs/dev/terraform.tfvars.example envs/dev/terraform.tfvars
cp envs/dev/ansible-vars.yml.example envs/dev/ansible-vars.yml

# Editar as configura√ß√µes
vim envs/dev/terraform.tfvars
vim envs/dev/ansible-vars.yml
```

### 2. Comandos Principais

```bash
# Ver todos os comandos dispon√≠veis
make help

# Deploy completo do ambiente
make deploy ENV=dev

# Deploy por componentes
make terraform-apply ENV=dev
make ansible-configure ENV=dev
make docker-deploy ENV=dev

# Verifica√ß√µes
make status ENV=dev
make health ENV=dev
make logs SERVICE=backend ENV=dev
```

### 3. Gest√£o de Ambientes

#### Desenvolvimento (Azure)

```bash
# Deploy para dev
make deploy ENV=dev

# Logs e monitoramento
make logs SERVICE=frontend ENV=dev
make health ENV=dev
```

#### Produ√ß√£o (AWS)

```bash
# Deploy para produ√ß√£o
make deploy ENV=prod

# Backup antes do deploy
make backup ENV=prod
```

## üîê Gest√£o de Segredos

### Verifica√ß√£o Antes de Commits

O sistema possui verifica√ß√£o autom√°tica de segredos antes de cada commit:

```bash
# Executar verifica√ß√£o manual
./scripts/security/pre-commit-security-check.sh

# Configurar como hook autom√°tico
cp .githooks/pre-commit .git/hooks/
chmod +x .git/hooks/pre-commit
```

### Rota√ß√£o de Segredos

```bash
# Rodar segredos do ambiente de desenvolvimento
./scripts/security/rotate-secrets.sh --environment dev

# Rota√ß√£o completa (produ√ß√£o)
./scripts/security/rotate-secrets.sh --environment prod --force
```

### Auditoria de Seguran√ßa

```bash
# Scan completo de seguran√ßa
./scripts/security/security-scan.sh --environment dev --type all

# Apenas containers
./scripts/security/security-scan.sh --environment dev --type containers
```

## üîÑ Fluxo de CI/CD

### 1. Deploy Autom√°tico

O sistema monitora mudan√ßas nas imagens Docker via webhooks:

```mermaid
graph LR
    A[Backend/Frontend Repo] --> B[Build & Push Docker]
    B --> C[Webhook para Infrastructure]
    C --> D[Deploy Autom√°tico]
    D --> E[Notifica√ß√£o Discord]
```

### 2. Workflows Dispon√≠veis

| Workflow | Trigger | Prop√≥sito |
|----------|---------|-----------|
| `ci-cd.yml` | `repository_dispatch`, manual | Deploy principal |
| `test.yml` | Pull requests | Valida√ß√£o r√°pida |
| `security-workflow.yml` | Schedule, manual | Pipeline de seguran√ßa |
| `build-database.yml` | Mudan√ßas no database/ | Build imagem PostgreSQL |

### 3. Repository Dispatch

Para triggar deploys de outros repos:

```bash
curl -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github.v3+json" \
  https://api.github.com/repos/AGES-Pro-Mata/infrastructure/dispatches \
  -d '{
    "event_type": "deploy-dev-frontend",
    "client_payload": {
      "environment": "dev",
      "image_tag": "latest"
    }
  }'
```

## üõ†Ô∏è Comandos √öteis

### Status e Monitoramento

```bash
# Status geral da infraestrutura
make status ENV=dev

# Health check de todos os servi√ßos
make health ENV=dev

# Logs de um servi√ßo espec√≠fico
make logs SERVICE=backend ENV=dev

# Estat√≠sticas dos containers
make stats ENV=dev
```

### Deploy e Rollback

```bash
# Deploy incremental
make deploy-quick ENV=dev

# Rollback para vers√£o anterior
make rollback ENV=dev

# Deploy de uma stack espec√≠fica
make deploy-stack STACK=database ENV=dev
```

### Backup e Restore

```bash
# Backup completo
make backup ENV=prod

# Backup apenas do banco de dados
./scripts/backup/backup-database.sh --environment prod

# Restaurar backup
./scripts/backup/restore-database.sh --environment dev --file backup.sql
```

### Terraform

```bash
# Planejar mudan√ßas
make terraform-plan ENV=dev

# Aplicar mudan√ßas
make terraform-apply ENV=dev

# Validar configura√ß√£o
make terraform-validate ENV=dev

# Destruir infraestrutura (cuidado!)
make terraform-destroy ENV=dev
```

### Ansible

```bash
# Configurar ambiente
make ansible-configure ENV=dev

# Executar playbook espec√≠fico
make ansible-run PLAYBOOK=deploy-complete ENV=dev

# Validar sintaxe
make ansible-validate ENV=dev
```

## üîß Configura√ß√£o de Vari√°veis

### Terraform Variables (`envs/{env}/terraform.tfvars`)

```hcl
# Azure/AWS
subscription_id = "your-subscription-id"
resource_group_location = "East US 2"

# Networking
domain_name = "promata.com.br"
enable_ssl = true

# Application
frontend_replicas = 2
backend_replicas = 2
database_backup_retention = 30
```

### Ansible Variables (`envs/{env}/ansible-vars.yml`)

```yaml
# Docker Swarm
swarm_advertise_addr: "{{ ansible_default_ipv4.address }}"
swarm_manager_count: 1

# Application
app_environment: development
log_level: info
monitoring_enabled: true

# Security
ssl_redirect: true
security_headers: true
```

## ÔøΩ Troubleshooting

### Problemas Comuns

#### Deploy Falha

```bash
# Verificar status dos servi√ßos
docker service ls
docker node ls

# Verificar logs
make logs SERVICE=failed-service ENV=dev

# Rollback se necess√°rio
make rollback ENV=dev
```

#### Problemas de Conectividade

```bash
# Testar conectividade entre servi√ßos
./scripts/utils/test-connectivity.sh

# Verificar DNS
nslookup promata.com.br

# Verificar certificados SSL
./scripts/utils/test-ssl.sh promata.com.br
```

#### Problemas de Autentica√ß√£o

```bash
# Verificar segredos
./scripts/security/security-audit.sh --check-secrets

# Rotar segredos se necess√°rio
./scripts/security/rotate-secrets.sh --environment dev
```

### Logs e Monitoramento

```bash
# Logs centralizados
docker service logs promata_backend

# M√©tricas dos containers
docker stats

# Usar Grafana (se dispon√≠vel)
open https://grafana.promata.com.br
```

## üîí Seguran√ßa

### Checklist de Seguran√ßa

- ‚úÖ Verifica√ß√£o autom√°tica de segredos antes dos commits
- ‚úÖ Rota√ß√£o autom√°tica de segredos (schedule)
- ‚úÖ Scan de vulnerabilidades nos containers
- ‚úÖ Auditoria de configura√ß√µes
- ‚úÖ SSL/TLS obrigat√≥rio
- ‚úÖ Network segmentation

### Comandos de Seguran√ßa

```bash
# Auditoria completa
./scripts/security/security-audit.sh --environment prod

# Scan de vulnerabilidades
./scripts/security/security-scan.sh --type all

# Monitor de seguran√ßa
./scripts/security/security-monitor.sh --environment prod
```

## ÔøΩ Suporte

### Notifica√ß√µes

O sistema est√° configurado para enviar notifica√ß√µes via Discord para:

- ‚úÖ Deploys bem-sucedidos
- ‚ùå Falhas nos deploys
- üîÑ Status de CI/CD
- üö® Alertas de seguran√ßa

### Contato

- **Time**: AGES PUCRS Pro-Mata
- **Discord**: Configure seu webhook em `DISCORD_WEBHOOK_URL`
- **Documenta√ß√£o**: Este README e coment√°rios no c√≥digo

---

**Pro-Mata Infrastructure** - Sistema de infraestrutura automatizada  
*Desenvolvido pela equipe AGES PUCRS para o projeto Pro-Mata*
