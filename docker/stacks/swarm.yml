# PRO-MATA Infrastructure - Docker Swarm Stack
# Multi-Node Deployment with High Availability
# Usage: docker stack deploy -c docker/stacks/swarm.yml promata

version: "3.8"

networks:
  promata_public:
    driver: overlay
    attachable: true
  promata_internal:
    driver: overlay
    attachable: true

volumes:
  postgres_data:
  traefik_certs:

secrets:
  traefik_auth:
    external: true

services:
  # === REVERSE PROXY ===
  traefik:
    image: traefik:v3.2
    command:
      # API e Dashboard
      - --api.dashboard=true
      - --api.insecure=false

      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      # Providers - Swarm mode
      - --providers.swarm=true
      - --providers.swarm.exposedbydefault=false
      - --providers.swarm.endpoint=unix:///var/run/docker.sock
      - --providers.swarm.watch=true

      # Certificados Let's Encrypt
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@promata.com.br}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json

      # Logs
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --accesslog=true

      # Segurança
      - --global.sendanonymoususage=false

    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
      - target: 8080
        published: 8080
        mode: host

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/letsencrypt

    networks:
      - promata_public

    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      labels:
        - traefik.enable=true
        - traefik.docker.network=promata_public

        # Middleware HTTPS redirect
        - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
        - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true

        # Dashboard
        - traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN_NAME:-promata.com.br}`)
        - traefik.http.routers.traefik-dashboard.service=api@internal
        - traefik.http.routers.traefik-dashboard.entrypoints=websecure
        - traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt
        - traefik.http.routers.traefik-dashboard.middlewares=traefik-auth,security-headers

        # Security headers
        - traefik.http.middlewares.security-headers.headers.sslredirect=true
        - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000
        - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true
        - traefik.http.middlewares.security-headers.headers.stsPreload=true
        - traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true
        - traefik.http.middlewares.security-headers.headers.frameDeny=true

        # Auth middleware
        - traefik.http.middlewares.traefik-auth.basicauth.usersfile=/run/secrets/traefik_auth

        # HTTP to HTTPS catchall
        - traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)
        - traefik.http.routers.http-catchall.entrypoints=web
        - traefik.http.routers.http-catchall.middlewares=redirect-to-https

    secrets:
      - traefik_auth

  # === FRONTEND PROXY (S3) ===
  frontend:
    image: nginx:alpine
    environment:
      - S3_WEBSITE_ENDPOINT=http://${S3_BUCKET_NAME}.s3-website.${AWS_REGION:-us-east-2}.amazonaws.com
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - AWS_REGION=${AWS_REGION:-us-east-2}
    configs:
      - source: nginx_s3_config
        target: /etc/nginx/templates/default.conf.template
    networks:
      - promata_public
    deploy:
      replicas: ${FRONTEND_REPLICAS:-2}
      placement:
        preferences:
          - spread: node.id
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 5s
        order: start-first
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'
      labels:
        - traefik.enable=true
        - traefik.docker.network=promata_public
        - traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME:-promata.com.br}`) || Host(`www.${DOMAIN_NAME:-promata.com.br}`)
        - traefik.http.routers.frontend.entrypoints=websecure
        - traefik.http.routers.frontend.tls.certresolver=letsencrypt
        - traefik.http.routers.frontend.middlewares=security-headers
        - traefik.http.services.frontend.loadbalancer.server.port=80
        - traefik.http.services.frontend.loadbalancer.sticky.cookie=false
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # === DATABASE ===
  postgres:
    image: postgres:17-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-promata}
      - POSTGRES_USER=${POSTGRES_USER:-promata}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST_AUTH_METHOD=scram-sha-256
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - promata_internal
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.database == true  # Deploy em node marcado para banco
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 1G
          cpus: '0.5'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-promata}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # === BACKEND API ===
  backend:
    image: ${BACKEND_IMAGE:-norohim/pro-mata-backend:latest}
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-promata}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-promata}?schema=app

      # Application
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-2h}

      # CORS
      - CORS_ORIGIN=https://${DOMAIN_NAME:-promata.com.br},https://www.${DOMAIN_NAME:-promata.com.br}
      - CORS_CREDENTIALS=true

      # Analytics
      - UMAMI_URL=https://analytics.${DOMAIN_NAME:-promata.com.br}
      - UMAMI_WEBSITE_ID=${UMAMI_WEBSITE_ID:-}

      # Logs
      - LOG_LEVEL=${LOG_LEVEL:-info}

    networks:
      - promata_public
      - promata_internal

    deploy:
      replicas: ${BACKEND_REPLICAS:-2}  # Múltiplas réplicas para HA
      placement:
        preferences:
          - spread: node.id  # Distribuir entre nodes
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first  # Zero-downtime deployment
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      labels:
        - traefik.enable=true
        - traefik.docker.network=promata_public
        - traefik.http.routers.backend.rule=Host(`api.${DOMAIN_NAME:-promata.com.br}`)
        - traefik.http.routers.backend.entrypoints=websecure
        - traefik.http.routers.backend.tls.certresolver=letsencrypt
        - traefik.http.routers.backend.middlewares=security-headers
        - traefik.http.services.backend.loadbalancer.server.port=3000
        # Load balancer config
        - traefik.http.services.backend.loadbalancer.sticky.cookie=true
        - traefik.http.services.backend.loadbalancer.sticky.cookie.name=promata_backend
        - traefik.http.services.backend.loadbalancer.sticky.cookie.secure=true
        - traefik.http.services.backend.loadbalancer.sticky.cookie.httpOnly=true

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # === ANALYTICS (Umami) ===
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-promata}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-promata}?schema=umami
      - DATABASE_TYPE=postgresql
      - APP_SECRET=${APP_SECRET}
      - DISABLE_TELEMETRY=1
    networks:
      - promata_public
      - promata_internal
    deploy:
      replicas: 1
      placement:
        constraints: []
      restart_policy:
        condition: on-failure
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      labels:
        - traefik.enable=true
        - traefik.docker.network=promata_public
        - traefik.http.routers.umami.rule=Host(`analytics.${DOMAIN_NAME:-promata.com.br}`)
        - traefik.http.routers.umami.entrypoints=websecure
        - traefik.http.routers.umami.tls.certresolver=letsencrypt
        - traefik.http.services.umami.loadbalancer.server.port=3000
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/heartbeat || exit 1"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 45s

  # === BUSINESS INTELLIGENCE (Metabase) ===
  metabase:
    image: metabase/metabase:v0.51.3
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_CONNECTION_URI=postgresql://${POSTGRES_USER:-promata}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-promata}?currentSchema=metabase
      - JAVA_OPTS=-Xmx1536m -Duser.timezone=America/Sao_Paulo
    networks:
      - promata_public
      - promata_internal
    deploy:
      replicas: 1
      placement:
        constraints: []
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'
      labels:
        - traefik.enable=true
        - traefik.docker.network=promata_public
        - traefik.http.routers.metabase.rule=Host(`metabase.${DOMAIN_NAME:-promata.com.br}`)
        - traefik.http.routers.metabase.entrypoints=websecure
        - traefik.http.routers.metabase.tls.certresolver=letsencrypt
        - traefik.http.routers.metabase.middlewares=security-headers
        - traefik.http.services.metabase.loadbalancer.server.port=3000

configs:
  nginx_s3_config:
    file: ../configs/nginx/s3-proxy.conf
