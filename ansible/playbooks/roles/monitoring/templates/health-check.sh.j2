#!/bin/bash
# System Health Check Script for Pro-Mata
# This script performs basic system health checks

LOG_FILE="/opt/promata/logs/health-check.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] Starting system health check..." >> "$LOG_FILE"

# Check CPU usage
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
echo "[$TIMESTAMP] CPU Usage: ${CPU_USAGE}%" >> "$LOG_FILE"

# Check memory usage
MEM_TOTAL=$(free -m | awk 'NR==2{printf "%.2f", $2/1024}')
MEM_USED=$(free -m | awk 'NR==2{printf "%.2f", $3/1024}')
MEM_USAGE=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
echo "[$TIMESTAMP] Memory Usage: ${MEM_USAGE}% (${MEM_USED}GB/${MEM_TOTAL}GB)" >> "$LOG_FILE"

# Check disk usage
DISK_USAGE=$(df / | tail -1 | awk '{print $5}')
echo "[$TIMESTAMP] Root Disk Usage: $DISK_USAGE" >> "$LOG_FILE"

# Check system load
LOAD_AVERAGE=$(uptime | awk -F'load average:' '{ print $2 }')
echo "[$TIMESTAMP] Load Average: $LOAD_AVERAGE" >> "$LOG_FILE"

# Check network connectivity
if ping -c 1 8.8.8.8 &> /dev/null; then
    echo "[$TIMESTAMP] Network connectivity: OK" >> "$LOG_FILE"
else
    echo "[$TIMESTAMP] Network connectivity: FAILED" >> "$LOG_FILE"
fi

# Check running processes
PROCESS_COUNT=$(ps aux | wc -l)
echo "[$TIMESTAMP] Running processes: $PROCESS_COUNT" >> "$LOG_FILE"

echo "[$TIMESTAMP] System health check completed" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"
