---
# Simplified deployment playbook for CI/CD
# Uses minimal variables and focuses on getting services running
- name: Deploy Pro-Mata Stack (Simplified)
  hosts: all
  become: true
  
  vars:
    project_name: "{{ lookup('env', 'PROJECT_NAME') | default('promata', true) }}"
    environment: "{{ lookup('env', 'ENVIRONMENT') | default('prod', true) }}"
    domain_name: "{{ lookup('env', 'DOMAIN_NAME') | default('promata.com.br', true) }}"
    
    # Secrets from environment
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') | default('changeme', true) }}"
    jwt_secret: "{{ lookup('env', 'JWT_SECRET') | default('changeme', true) }}"
    app_secret: "{{ lookup('env', 'APP_SECRET') | default('changeme', true) }}"
    
    # AWS Configuration
    aws_region: "{{ lookup('env', 'AWS_REGION') | default('sa-east-1', true) }}"
    s3_bucket_name: "{{ lookup('env', 'S3_BUCKET_NAME') | default('', true) }}"
    cloudflare_api_token: "{{ lookup('env', 'CLOUDFLARE_API_TOKEN') | default('', true) }}"
  
  tasks:
    # ========================================================================
    # DOCKER SETUP
    # ========================================================================
    - name: Wait for cloud-init to complete
      shell: cloud-init status --wait || true
      timeout: 300

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: true

    - name: Install Docker (if not present)
      when: docker_check.rc != 0
      block:
        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker CE
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: yes

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # ========================================================================
    # APPLICATION SETUP
    # ========================================================================
    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - /opt/promata
        - /opt/promata/configs
        - /opt/promata/data
        - /opt/promata/logs
        - /opt/promata/docker/configs/nginx
        - /opt/promata/docker/database/scripts/init

    # IMPORTANT: Ensure traefik.yml is a FILE not a directory
    - name: Remove traefik config if it's a directory (fix common issue)
      shell: |
        if [ -d "/opt/promata/docker/configs/traefik/traefik.yml" ]; then
          rm -rf /opt/promata/docker/configs/traefik/traefik.yml
        fi
        mkdir -p /opt/promata/docker/configs/traefik
      args:
        executable: /bin/bash

    - name: Download docker-compose.yml from repository
      get_url:
        url: "https://raw.githubusercontent.com/AGES-Pro-Mata/infrastructure/main/docker-compose.yml"
        dest: /opt/promata/docker-compose.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      register: compose_download
      retries: 3
      delay: 5

    - name: Create .env file
      copy:
        dest: /opt/promata/.env
        owner: ubuntu
        group: ubuntu
        mode: '0600'
        content: |
          # Pro-Mata Environment Configuration
          # Generated by Ansible - {{ ansible_date_time.iso8601 }}
          
          # Environment
          ENVIRONMENT={{ environment }}
          PROJECT_NAME={{ project_name }}
          
          # Domain
          DOMAIN_NAME={{ domain_name }}
          ACME_EMAIL=admin@{{ domain_name }}
          
          # Database
          POSTGRES_DB=promata
          POSTGRES_USER=promata
          POSTGRES_PASSWORD={{ postgres_password }}
          
          # Application
          JWT_SECRET={{ jwt_secret }}
          APP_SECRET={{ app_secret }}
          DATABASE_URL=postgresql://promata:{{ postgres_password }}@postgres:5432/promata?schema=app
          
          # AWS S3 Storage
          AWS_REGION={{ aws_region }}
          AWS_S3_BUCKET={{ s3_bucket_name }}
          S3_BUCKET_NAME={{ s3_bucket_name }}
          
          # Cloudflare (for Traefik DNS challenge)
          CLOUDFLARE_API_TOKEN={{ cloudflare_api_token }}
          
          # Traefik
          TRAEFIK_LOG_LEVEL=INFO
          
          # Backend Image
          BACKEND_IMAGE=norohim/pro-mata-backend:latest

    - name: Download Traefik config
      get_url:
        url: "https://raw.githubusercontent.com/AGES-Pro-Mata/infrastructure/main/docker/configs/traefik/traefik.yml"
        dest: /opt/promata/docker/configs/traefik/traefik.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        force: yes
      register: traefik_config
      retries: 3
      delay: 5
      ignore_errors: true

    - name: Create Traefik config (always ensure file exists)
      copy:
        dest: /opt/promata/docker/configs/traefik/traefik.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        force: yes
        content: |
          api:
            dashboard: true
            insecure: false
          
          entryPoints:
            web:
              address: ":80"
              http:
                redirections:
                  entryPoint:
                    to: websecure
                    scheme: https
            websecure:
              address: ":443"
          
          providers:
            docker:
              endpoint: "unix:///var/run/docker.sock"
              exposedByDefault: false
          
          certificatesResolvers:
            letsencrypt:
              acme:
                email: admin@{{ domain_name }}
                storage: /letsencrypt/acme.json
                httpChallenge:
                  entryPoint: web
          
          log:
            level: INFO

    - name: Download nginx S3 proxy config
      get_url:
        url: "https://raw.githubusercontent.com/AGES-Pro-Mata/infrastructure/main/docker/configs/nginx/s3-proxy.conf"
        dest: /opt/promata/docker/configs/nginx/s3-proxy.conf
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      ignore_errors: true

    - name: Create database init script for schemas
      copy:
        dest: /opt/promata/docker/database/scripts/init/01-create-schemas.sh
        owner: ubuntu
        group: ubuntu
        mode: '0755'
        content: |
          #!/bin/bash
          set -e
          psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
              CREATE SCHEMA IF NOT EXISTS app;
              CREATE SCHEMA IF NOT EXISTS umami;
              CREATE SCHEMA IF NOT EXISTS metabase;
              ALTER DATABASE ${POSTGRES_DB} SET search_path TO app,public;
              GRANT ALL PRIVILEGES ON SCHEMA app TO ${POSTGRES_USER};
              GRANT ALL PRIVILEGES ON SCHEMA umami TO ${POSTGRES_USER};
              GRANT ALL PRIVILEGES ON SCHEMA metabase TO ${POSTGRES_USER};
          EOSQL
          echo "✅ Database schemas initialized!"

    # ========================================================================
    # START SERVICES
    # ========================================================================
    - name: Stop existing containers for clean start
      shell: |
        cd /opt/promata
        docker compose down --remove-orphans 2>/dev/null || docker-compose down --remove-orphans 2>/dev/null || true
      become_user: ubuntu
      ignore_errors: true

    - name: Pull Docker images
      shell: |
        cd /opt/promata
        docker compose pull || docker-compose pull
      become_user: ubuntu
      ignore_errors: true

    - name: Start PostgreSQL first
      shell: |
        cd /opt/promata
        docker compose up -d postgres || docker-compose up -d postgres
      become_user: ubuntu

    - name: Wait for PostgreSQL to be ready
      shell: |
        for i in {1..30}; do
          docker exec promata-postgres pg_isready -U promata && break
          sleep 2
        done
      retries: 3
      delay: 5

    - name: Create database schemas (idempotent)
      shell: |
        docker exec -i promata-postgres psql -U promata -d promata <<'EOSQL'
        CREATE SCHEMA IF NOT EXISTS app;
        CREATE SCHEMA IF NOT EXISTS umami;
        CREATE SCHEMA IF NOT EXISTS metabase;
        ALTER DATABASE promata SET search_path TO app,public;
        GRANT ALL PRIVILEGES ON SCHEMA app TO promata;
        GRANT ALL PRIVILEGES ON SCHEMA umami TO promata;
        GRANT ALL PRIVILEGES ON SCHEMA metabase TO promata;
        EOSQL
      register: schema_result
      ignore_errors: true

    - name: Reset Metabase schema if corrupted (fresh install)
      shell: |
        # Check if metabase has incomplete migrations
        TABLES=$(docker exec -i promata-postgres psql -U promata -d promata -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'metabase';" 2>/dev/null | tr -d ' ')
        if [ "$TABLES" -gt 0 ] && [ "$TABLES" -lt 50 ]; then
          echo "Metabase schema appears corrupted (only $TABLES tables). Resetting..."
          docker exec -i promata-postgres psql -U promata -d promata -c "DROP SCHEMA IF EXISTS metabase CASCADE; CREATE SCHEMA metabase; GRANT ALL PRIVILEGES ON SCHEMA metabase TO promata;"
        fi
      ignore_errors: true

    - name: Start all services with Docker Compose
      shell: |
        cd /opt/promata
        docker compose up -d || docker-compose up -d
      become_user: ubuntu
      register: compose_up
      retries: 2
      delay: 10

    - name: Wait for services to initialize
      pause:
        seconds: 45

    # ========================================================================
    # POST-DEPLOY FIXES
    # ========================================================================
    - name: Fix Frontend health check (create /health file)
      shell: |
        docker exec promata-frontend sh -c 'echo "OK" > /usr/share/nginx/html/health' 2>/dev/null || true
      ignore_errors: true

    - name: Check if Traefik is running properly
      shell: |
        STATUS=$(docker inspect --format='{{ "{{" }}.State.Status{{ "}}" }}' promata-traefik 2>/dev/null || echo "not_found")
        if [ "$STATUS" = "restarting" ]; then
          echo "Traefik is restarting, checking logs..."
          docker logs --tail 5 promata-traefik 2>&1
          # Force recreate traefik
          cd /opt/promata
          docker compose up -d --force-recreate traefik || docker-compose up -d --force-recreate traefik
        fi
      ignore_errors: true

    - name: Check if Metabase needs restart
      shell: |
        # Wait a bit for metabase to try starting
        sleep 10
        STATUS=$(docker inspect --format='{{ "{{" }}.State.Status{{ "}}" }}' promata-metabase 2>/dev/null || echo "not_found")
        RESTARTS=$(docker inspect --format='{{ "{{" }}.RestartCount{{ "}}" }}' promata-metabase 2>/dev/null || echo "0")
        if [ "$STATUS" = "restarting" ] || [ "$RESTARTS" -gt 3 ]; then
          echo "Metabase failing, resetting schema..."
          docker exec -i promata-postgres psql -U promata -d promata -c "DROP SCHEMA IF EXISTS metabase CASCADE; CREATE SCHEMA metabase; GRANT ALL PRIVILEGES ON SCHEMA metabase TO promata;"
          docker restart promata-metabase
        fi
      ignore_errors: true

    - name: Final wait for all services
      pause:
        seconds: 30

    - name: Check running containers
      shell: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
      register: docker_ps

    - name: Display running containers
      debug:
        var: docker_ps.stdout_lines

    # ========================================================================
    # HEALTH CHECKS & VALIDATION
    # ========================================================================
    - name: Validate all containers are running
      shell: |
        FAILED=0
        for container in promata-postgres promata-backend promata-traefik promata-umami promata-frontend; do
          STATUS=$(docker inspect --format='{{ "{{" }}.State.Status{{ "}}" }}' $container 2>/dev/null || echo "not_found")
          if [ "$STATUS" != "running" ]; then
            echo "❌ $container is $STATUS"
            FAILED=1
          else
            echo "✅ $container is running"
          fi
        done
        exit $FAILED
      register: container_validation
      ignore_errors: true
      retries: 2
      delay: 15

    - name: Check Backend API health
      uri:
        url: "http://localhost:3000/health"
        method: GET
        status_code: [200]
      register: backend_health
      ignore_errors: true
      retries: 5
      delay: 10
      delegate_to: "{{ inventory_hostname }}"

    - name: Check Traefik is responding
      uri:
        url: "http://localhost:80"
        method: GET
        status_code: [200, 301, 302, 404, 503]
      register: traefik_health
      ignore_errors: true
      retries: 3
      delay: 10

    - name: Get final container status
      shell: |
        echo "=== Container Health Summary ==="
        docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}{% endraw %}" | grep promata
        echo ""
        echo "=== Restart Counts ==="
        for c in promata-postgres promata-backend promata-traefik promata-umami promata-metabase promata-frontend; do
          RESTARTS=$(docker inspect --format='{{ "{{" }}.RestartCount{{ "}}" }}' $c 2>/dev/null || echo "N/A")
          echo "$c: $RESTARTS restarts"
        done
      register: final_status

    - name: Display final status
      debug:
        var: final_status.stdout_lines

    - name: Deployment Summary
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║               PRO-MATA DEPLOYMENT COMPLETE                  ║
          ╠══════════════════════════════════════════════════════════════╣
          ║ Domain: {{ domain_name }}
          ║ Environment: {{ environment }}
          ║                                                              
          ║ Services:                                                    
          ║   • API:        https://api.{{ domain_name }}
          ║   • Frontend:   https://{{ domain_name }}
          ║   • Analytics:  https://analytics.{{ domain_name }}
          ║   • Metabase:   https://bi.{{ domain_name }}
          ║   • Traefik:    https://traefik.{{ domain_name }}
          ║                                                              
          ║ Backend API: {{ 'HEALTHY ✅' if backend_health.status == 200 else 'STARTING... ⏳' }}
          ║ Traefik: {{ 'RESPONDING ✅' if traefik_health.status is defined else 'STARTING... ⏳' }}
          ║                                                              
          ║ Note: SSL certificates may take 1-2 minutes to provision.   
          ╚══════════════════════════════════════════════════════════════╝
