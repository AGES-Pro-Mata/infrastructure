# Docker Compose Deployment Guide

## Overview

This guide covers automated deployment of the Pro-Mata stack using Docker Compose on a single EC2 instance.

## Prerequisites

1. **AWS Credentials** configured (`~/.aws/credentials`)
2. **Cloudflare API Token** with permissions:
   - Zone:DNS:Edit
   - Zone:Zone:Read
   - Get token from: https://dash.cloudflare.com/profile/api-tokens
3. **Terraform** installed (v1.0+)
4. **Environment variables** set:

```bash
export CLOUDFLARE_API_TOKEN="your-token-here"
export CLOUDFLARE_ZONE_ID="your-zone-id"
export DOMAIN_NAME="promata.com.br"
export AWS_REGION="sa-east-1"
export ACME_EMAIL="admin@promata.com.br"
export BACKEND_IMAGE="norohim/pro-mata-backend:latest"
```

## Quick Start - Full Automated Deployment

Deploy everything with one command:

```bash
make deploy-compose-full ENV=prod \
  CLOUDFLARE_API_TOKEN=$CLOUDFLARE_API_TOKEN \
  DOMAIN_NAME=promata.com.br \
  AWS_REGION=sa-east-1
```

This command will:
1. ✅ Deploy AWS infrastructure (VPC, EC2, S3, SES, Cloudflare DNS)
2. ✅ Extract SSH keys
3. ✅ Copy docker-compose.yml and configs to EC2
4. ✅ Generate `.env` file with secure random secrets
5. ✅ Start Docker Compose stack
6. ✅ Verify services are running

## Step-by-Step Manual Deployment

### 1. Deploy Infrastructure (IaC)

```bash
make tf-apply ENV=prod INSTANCE_COUNT=1 ENABLE_CLOUDFLARE=true
```

Output will include:
- Instance IP
- S3 bucket name
- DNS records created

### 2. Extract SSH Keys

```bash
make extract-ssh-keys ENV=prod
```

Keys saved to: `envs/prod/.ssh/id_rsa`

### 3. Deploy Docker Compose Stack

```bash
make deploy-compose ENV=prod \
  CLOUDFLARE_API_TOKEN=$CLOUDFLARE_API_TOKEN \
  DOMAIN_NAME=promata.com.br
```

## Services Deployed

| Service | Port | URL | Description |
|---------|------|-----|-------------|
| **Traefik** | 80, 443, 8080 | `traefik.promata.com.br` | Reverse proxy & SSL |
| **Frontend** | 80 | `promata.com.br`, `www.promata.com.br` | Nginx → S3 static site |
| **Backend** | 3001 | `api.promata.com.br` | NestJS API |
| **Postgres** | 5432 | Internal | Database |
| **Umami** | 3000 | `analytics.promata.com.br` | Analytics |
| **Metabase** | 3000 | `metabase.promata.com.br` | Business Intelligence |

## SSL Certificate Generation

### DNS Challenge (Automated - Recommended)

The stack is configured to use **Cloudflare DNS-01 challenge** which works with proxied DNS records:

1. **Traefik** automatically requests certificates from Let's Encrypt
2. **DNS challenge** creates TXT records via Cloudflare API
3. **Certificates** are issued within 1-2 minutes
4. **Auto-renewal** happens 30 days before expiry

**Requirements:**
- `CLOUDFLARE_API_TOKEN` must be set in `.env`
- Token needs `Zone:DNS:Edit` permission

### HTTP Challenge (Alternative)

If you don't have Cloudflare API token, temporarily disable proxy:

1. Set `proxied=false` in `iac/aws/modules/dns/main.tf`
2. Apply: `make tf-apply ENV=prod`
3. Wait for certificates (1-2 minutes)
4. Re-enable proxy: `proxied=true`
5. Apply again

## Troubleshooting

### 526 Error (Cloudflare)

**Symptom:** `error code: 526` when accessing HTTPS

**Cause:** Cloudflare can't validate origin SSL certificate

**Solutions:**
1. **Wait 2 minutes** for DNS challenge to complete
2. Check Traefik logs: `ssh -i envs/prod/.ssh/id_rsa ubuntu@<IP> 'docker compose -f /opt/promata/docker-compose.yml logs traefik'`
3. Verify CLOUDFLARE_API_TOKEN is set in `.env`
4. Check token permissions include `Zone:DNS:Edit`

### Services Not Starting

```bash
# SSH to instance
make ssh-instance ENV=prod

# Check service status
cd /opt/promata
docker compose ps

# View logs
docker compose logs <service-name>

# Restart services
docker compose restart
```

### Backend Crashes

**Common causes:**
- Missing `AWS_S3_BUCKET` or `AWS_S3_REGION`
- Invalid `DATABASE_URL`
- Missing `JWT_SECRET`

**Solution:** Check `.env` file on instance has all required variables

### Frontend 404

**Cause:** S3 bucket not configured for website hosting

**Solution:**
```bash
# Configure S3 bucket for website hosting (Terraform should handle this)
make tf-apply ENV=prod
```

## Environment Variables

### Required Variables

```bash
# Domain & DNS
DOMAIN_NAME=promata.com.br
CLOUDFLARE_API_TOKEN=<get-from-cloudflare>

# AWS
AWS_REGION=sa-east-1
S3_BUCKET_NAME=<auto-generated-by-terraform>

# Database
POSTGRES_DB=promata
POSTGRES_USER=promata
POSTGRES_PASSWORD=<auto-generated>

# Backend
NODE_ENV=production
JWT_SECRET=<auto-generated>
JWT_EXPIRES_IN=2h
BACKEND_IMAGE=norohim/pro-mata-backend:latest
AWS_S3_BUCKET=${S3_BUCKET_NAME}
AWS_S3_REGION=${AWS_REGION}

# Analytics
APP_SECRET=<auto-generated>
UMAMI_WEBSITE_ID=<empty-initially>

# Traefik
ACME_EMAIL=admin@promata.com.br
TRAEFIK_LOG_LEVEL=INFO
```

### Auto-generated Secrets

The following are automatically generated during deployment:
- `POSTGRES_PASSWORD` - 32-byte random base64
- `JWT_SECRET` - 32-byte random base64
- `APP_SECRET` - 32-byte random base64

## Updating Services

### Update Docker Images

```bash
# SSH to instance
make ssh-instance ENV=prod

# Pull latest images and restart
cd /opt/promata
docker compose pull
docker compose up -d
```

### Update Configuration

```bash
# Update local files
vim docker-compose.yml

# Deploy changes
make deploy-compose ENV=prod
```

## Cleanup

### Destroy Everything

```bash
make tf-destroy ENV=prod INSTANCE_COUNT=1
```

This removes:
- EC2 instances
- VPC and networking
- S3 buckets
- Cloudflare DNS records
- SSH keys

## Architecture

```
┌─────────────────────────────────────────────────────┐
│ Cloudflare (Proxy + DNS)                            │
│ ✓ DNS Records (A records, proxied)                  │
│ ✓ SSL/TLS (Edge certificates)                       │
│ ✓ DDoS Protection                                    │
└────────────────┬────────────────────────────────────┘
                 │ HTTPS
                 ▼
┌─────────────────────────────────────────────────────┐
│ AWS EC2 Instance (t2.medium)                        │
│                                                      │
│  ┌────────────────────────────────────────────┐    │
│  │ Traefik (Reverse Proxy)                    │    │
│  │ ✓ Let's Encrypt DNS Challenge              │    │
│  │ ✓ Automatic HTTPS                          │    │
│  │ ✓ Docker label-based routing               │    │
│  └────┬──────────────────────────────────────┬┘    │
│       │                                       │     │
│  ┌────▼────────┐  ┌──────────┐  ┌───────────▼──┐  │
│  │ Frontend    │  │ Backend  │  │ Umami/        │  │
│  │ (Nginx→S3)  │  │ (NestJS) │  │ Metabase      │  │
│  └─────────────┘  └────┬─────┘  └───────┬───────┘  │
│                        │                 │          │
│                   ┌────▼─────────────────▼──┐       │
│                   │ PostgreSQL 17          │       │
│                   │ (app, umami, metabase) │       │
│                   └────────────────────────┘       │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ AWS S3          │
                │ Static Assets   │
                └─────────────────┘
```

## Next Steps

1. **Upload frontend** to S3 bucket
2. **Configure Umami** - Get website ID
3. **Configure Metabase** - Connect to database
4. **Set up monitoring** - CloudWatch/Grafana
5. **Configure backups** - S3 database backups

## Support

- Infrastructure issues: Check Terraform state
- Service issues: Check Docker Compose logs
- SSL issues: Check Traefik logs and Cloudflare settings
