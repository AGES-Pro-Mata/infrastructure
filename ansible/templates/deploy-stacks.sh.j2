#!/bin/bash
# Pro-Mata Stack Deployment Script
# Generated by Ansible

set -euo pipefail

STACK_DIR="/opt/promata/stacks"
ENV_FILE="/opt/promata/.env"

echo "==> Pro-Mata Stack Deployment Starting..."
echo "Environment: {{ env_name }}"
echo "Domain: {{ domain_name }}"

# Source environment variables
if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
else
    echo "[ERROR] Environment file not found at $ENV_FILE"
    exit 1
fi

# Function to deploy stack
deploy_stack() {
    local stack_name=$1
    local stack_file=$2
    
    echo "[DEPLOY] Deploying $stack_name stack..."
    if docker stack deploy -c "$STACK_DIR/$stack_file" --with-registry-auth "$stack_name"; then
        echo "[SUCCESS] $stack_name deployed successfully"
        return 0
    else
        echo "[ERROR] Failed to deploy $stack_name"
        return 1
    fi
}

# Function to wait for stack to be ready
wait_for_stack() {
    local stack_name=$1
    local timeout=300
    local count=0
    
    echo "[WAIT] Waiting for $stack_name to be ready..."
    while [ $count -lt $timeout ]; do
        if docker service ls --filter name="${stack_name}_" --format "table {{ "{{" }}.Name{{ "}}" }}\t{{ "{{" }}.Replicas{{ "}}" }}" | grep -q "1/1\|2/2"; then
            echo "[SUCCESS] $stack_name is ready"
            return 0
        fi
        sleep 10
        count=$((count + 10))
        echo "[WAIT] Still waiting... (${count}s/${timeout}s)"
    done
    
    echo "[ERROR] Timeout waiting for $stack_name to be ready"
    return 1
}

# Deploy stacks in order
echo "[1/4] Deploying Proxy Stack (Traefik)..."
if deploy_stack "promata-proxy" "proxy-stack.yml"; then
    wait_for_stack "promata-proxy"
else
    exit 1
fi

echo "[2/4] Deploying Database Stack..."
if deploy_stack "promata-database" "database-stack.yml"; then
    wait_for_stack "promata-database"
else
    exit 1
fi

echo "[3/4] Deploying Application Stack..."
if deploy_stack "promata-app" "app-stack.yml"; then
    wait_for_stack "promata-app"
else
    exit 1
fi

echo ""
echo "[SUCCESS] All stacks deployed successfully!"
echo ""
echo "[INFO] Stack Summary:"
docker stack ls
echo ""
echo "[INFO] Your application should be available at:"
echo "   Frontend: https://{{ domain_name }}"
echo "   API:      https://api.{{ domain_name }}"
echo "   Traefik:  https://traefik.{{ domain_name }}"
echo ""
echo "[INFO] SSL certificates may take 1-2 minutes to provision"
echo ""
echo "[INFO] Check status with: promata-status"
echo "[INFO] View logs with:    promata-logs [service-name]"