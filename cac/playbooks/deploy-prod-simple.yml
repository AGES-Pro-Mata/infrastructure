---
# Simplified deployment playbook for CI/CD
# Uses minimal variables and focuses on getting services running
- name: Deploy Pro-Mata Stack (Simplified)
  hosts: all
  become: true
  
  vars:
    project_name: "{{ lookup('env', 'PROJECT_NAME') | default('promata', true) }}"
    environment: "{{ lookup('env', 'ENVIRONMENT') | default('prod', true) }}"
    domain_name: "{{ lookup('env', 'DOMAIN_NAME') | default('promata.com.br', true) }}"
    
    # Secrets from environment
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') | default('changeme', true) }}"
    jwt_secret: "{{ lookup('env', 'JWT_SECRET') | default('changeme', true) }}"
    app_secret: "{{ lookup('env', 'APP_SECRET') | default('changeme', true) }}"
  
  tasks:
    # ========================================================================
    # DOCKER SETUP
    # ========================================================================
    - name: Wait for cloud-init to complete
      shell: cloud-init status --wait || true
      timeout: 300

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: true

    - name: Install Docker (if not present)
      when: docker_check.rc != 0
      block:
        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker CE
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: yes

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # ========================================================================
    # APPLICATION SETUP
    # ========================================================================
    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - /opt/promata
        - /opt/promata/configs
        - /opt/promata/data
        - /opt/promata/logs

    - name: Download docker-compose.yml from repository
      get_url:
        url: "https://raw.githubusercontent.com/AGES-Pro-Mata/infrastructure/main/docker-compose.yml"
        dest: /opt/promata/docker-compose.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      register: compose_download
      retries: 3
      delay: 5

    - name: Create .env file
      copy:
        dest: /opt/promata/.env
        owner: ubuntu
        group: ubuntu
        mode: '0600'
        content: |
          # Pro-Mata Environment Configuration
          # Generated by Ansible - {{ ansible_date_time.iso8601 }}
          
          # Environment
          ENVIRONMENT={{ environment }}
          PROJECT_NAME={{ project_name }}
          
          # Domain
          DOMAIN_NAME={{ domain_name }}
          ACME_EMAIL=admin@{{ domain_name }}
          
          # Database
          POSTGRES_DB=promata
          POSTGRES_USER=promata
          POSTGRES_PASSWORD={{ postgres_password }}
          
          # Application
          JWT_SECRET={{ jwt_secret }}
          APP_SECRET={{ app_secret }}
          DATABASE_URL=postgresql://promata:{{ postgres_password }}@postgres:5432/promata?schema=public
          
          # Traefik
          TRAEFIK_LOG_LEVEL=INFO
          
          # Backend Image
          BACKEND_IMAGE=norohim/pro-mata-backend:latest

    - name: Download Traefik config
      get_url:
        url: "https://raw.githubusercontent.com/AGES-Pro-Mata/infrastructure/main/docker/configs/traefik/traefik.yml"
        dest: /opt/promata/configs/traefik.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      ignore_errors: true

    # ========================================================================
    # START SERVICES
    # ========================================================================
    - name: Pull Docker images
      shell: |
        cd /opt/promata
        docker compose pull || docker-compose pull
      become_user: ubuntu
      ignore_errors: true

    - name: Start services with Docker Compose
      shell: |
        cd /opt/promata
        docker compose up -d || docker-compose up -d
      become_user: ubuntu
      register: compose_up
      retries: 2
      delay: 10

    - name: Wait for services to start
      pause:
        seconds: 30

    - name: Check running containers
      shell: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
      register: docker_ps

    - name: Display running containers
      debug:
        var: docker_ps.stdout_lines

    # ========================================================================
    # HEALTH CHECKS
    # ========================================================================
    - name: Check Traefik health
      uri:
        url: "http://localhost:80"
        method: GET
        status_code: [200, 301, 302, 404, 503]
      register: traefik_health
      ignore_errors: true
      retries: 3
      delay: 10

    - name: Display health status
      debug:
        msg: |
          === Deployment Summary ===
          Domain: {{ domain_name }}
          Environment: {{ environment }}
          Traefik Status: {{ 'OK' if traefik_health.status is defined else 'Starting...' }}
          
          Services should be available at:
          - API: https://api.{{ domain_name }}
          - Traefik Dashboard: https://traefik.{{ domain_name }}
          
          Note: SSL certificates may take 1-2 minutes to provision.
