#!/bin/bash

# security-status.sh - Status do sistema de seguran√ßa

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

echo "üîê Pro-Mata Security System Status"
echo "=================================="
echo ""

# Verificar monitoramento
if pgrep -f "security-monitor.sh" > /dev/null; then
    echo "‚úÖ Monitoramento: ATIVO"
else
    echo "‚ùå Monitoramento: INATIVO"
fi

# Verificar √∫ltimo scan
if [[ -f "$PROJECT_ROOT/reports/security-scan/latest-scan.txt" ]]; then
    last_scan=$(stat -c %y "$PROJECT_ROOT/reports/security-scan/latest-scan.txt" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1)
    echo "‚úÖ √öltimo scan: $last_scan"
else
    echo "‚ùå Nenhum scan encontrado"
fi

# Verificar alertas recentes
alert_count=$(find "$PROJECT_ROOT/monitoring" -name "alert-*.json" 2>/dev/null | wc -l)
echo "üö® Alertas ativos: $alert_count"

# Verificar configura√ß√£o
if [[ -f "$PROJECT_ROOT/security/security-config.yml" ]]; then
    echo "‚úÖ Configura√ß√£o: OK"
else
    echo "‚ùå Configura√ß√£o: AUSENTE"
fi

# Verificar depend√™ncias essenciais
echo ""
echo "üìã Depend√™ncias:"
for cmd in docker curl jq openssl; do
    if command -v "$cmd" &> /dev/null; then
        echo "  ‚úÖ $cmd"
    else
        echo "  ‚ùå $cmd"
    fi
done

echo ""
echo "üìä Uso de recursos:"
echo "  CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')"
echo "  RAM: $(free -h | awk 'NR==2{printf "%.1f%%", $3*100/$2 }')"
echo "  Disco: $(df -h / | awk 'NR==2{print $5}')"

echo ""
echo "Para mais detalhes, execute:"
echo "  make security-check ENVIRONMENT=dev"
